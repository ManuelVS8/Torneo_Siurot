<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>Ajedrez Siurot</title>
    <link rel="icon" href="https://raw.githubusercontent.com/ManuelVS8/Torneo_Ajedrez_Siurot/refs/heads/main/Ajedrez.ico" type="image/x-icon">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50; --secondary: #ecf0f1; --accent: #e67e22; 
            --accent-light: #fcefe9; --success: #27ae60; --win-color: #27ae60; 
            --loss-color: #e74c3c; --draw-color: #3498db; --round-done: #d1ecf1; 
            --round-done-text: #0c5460; --danger: #c0392b; --text: #333; 
            --light-text: #7f8c8d; --border: #bdc3c7; --card-bg: #ffffff;
        }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { margin: 0; padding: 0; background-color: var(--secondary); color: var(--text); padding-bottom: 80px; }
        header { background-color: var(--primary); color: white; padding: 1rem; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; }
        .header-text { text-align: left; flex: 1; }
        h1 { margin: 0; font-size: 1.3rem; }
        .subtitle { font-size: 0.85rem; opacity: 0.9; margin-top: 2px; font-weight: normal; }
        #adminBtn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 50%; width: 40px; height: 40px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; margin-left: 10px; flex-shrink: 0; }
        #adminBtn.unlocked { background-color: var(--success); border-color: var(--success); }
        .container { padding: 1rem; max-width: 600px; margin: 0 auto; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity:1; } }
        .card { background: var(--card-bg); border-radius: 10px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; }
        body.is-locked .editable-element { opacity: 0.3; pointer-events: none; user-select: none; }
        .lock-overlay { display: none; text-align: center; color: var(--danger); padding: 10px; font-weight: bold; font-size: 0.9rem; background: rgba(255,255,255,0.9); border-radius: 5px; margin-bottom: 10px; }
        body.is-locked .show-lock-msg .lock-overlay { display: block; }
        textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid var(--border); border-radius: 5px; resize: vertical; font-size: 16px; }
        button { background-color: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 5px; font-size: 1rem; cursor: pointer; width: 100%; margin-top: 10px; font-weight: bold; transition: background 0.2s; }
        button:active { transform: scale(0.98); }
        button.export { background-color: var(--success); }
        button.danger { background-color: var(--danger); }
        .match-card { display: flex; flex-direction: column; background: var(--card-bg); border-radius: 8px; padding: 10px; margin-bottom: 12px; border-left: 4px solid var(--accent); position: relative; }
        .match-header { font-size: 0.8rem; color: var(--light-text); margin-bottom: 5px; text-transform: uppercase; font-weight: bold; }
        .players { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .player-name { font-weight: 600; flex:1; transition: color 0.3s ease; }
        .player-name.winner { color: var(--win-color); }
        .player-name.loser { color: var(--loss-color); }
        .player-name.draw { color: var(--draw-color); }
        .vs { font-size: 0.8rem; color: var(--light-text); padding: 0 5px; }
        .result-select { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--border); background: #fafafa; font-size: 1rem; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: var(--primary); color: white; font-size: 0.9rem; }
        .points-col { text-align: right; font-weight: bold; color: var(--accent); }
        .rank-col { width: 40px; text-align: center; color: var(--light-text); font-weight: bold; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); z-index: 99; }
        .nav-item { text-align: center; color: var(--light-text); font-size: 0.75rem; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--accent); font-weight: bold; }
        .nav-icon { font-size: 1.2rem; display: block; margin-bottom: 2px; }
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 90px; transform: translateX(-50%); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 60px; opacity: 0;} to {bottom: 90px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 90px; opacity: 1;} to {bottom: 60px; opacity: 0;} }
        #loadingOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 300; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .round-selector { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; margin-bottom: 15px; }
        .round-chip { background: #eee; color: #555; padding: 5px 15px; border-radius: 20px; white-space: nowrap; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; }
        .round-chip.active { background: var(--accent) !important; color: white !important; }
        .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 400px; text-align: center; }
    </style>
</head>
<body class="is-locked">

<div id="loadingOverlay"><div class="spinner"></div><div id="loadingText">Cargando aplicaci√≥n...</div></div>

<header>
    <div class="header-text"><h1>Ajedrez Siurot</h1><div class="subtitle">Torneo CEIP Manuel Siurot 2026</div></div>
    <button id="adminBtn" onclick="openPasswordModal()">üîí</button>
</header>

<div class="container">
    <div id="tab-setup" class="tab-content active">
        <div class="card show-lock-msg">
            <h3>1. Registro de Jugadores</h3>
            <div class="lock-overlay">üîí Modo lectura</div>
            <textarea id="playersInput" class="editable-element" placeholder="Un nombre por l√≠nea..."></textarea>
            <button class="editable-element" onclick="confirmStartTournament()">Crear Calendario</button>
        </div>
        <div class="card show-lock-msg" id="resetCard" style="display:none;">
            <button class="editable-element danger" onclick="confirmResetTournament()">Borrar Todo el Torneo</button>
        </div>
    </div>

    <div id="tab-rounds" class="tab-content">
        <div class="round-selector" id="roundSelector"></div>
        <div id="matchesContainer"></div>
        <div class="card show-lock-msg" style="padding:0; background:transparent; box-shadow:none;">
            <div class="lock-overlay">üîí Desbloquea para guardar</div>
            <button id="saveBtn" class="editable-element" onclick="syncToGoogle()">Guardar Resultados</button>
        </div>
    </div>

    <div id="tab-ranking" class="tab-content">
        <div class="card">
            <h3>Clasificaci√≥n General</h3>
            <table id="rankingTable">
                <thead><tr><th class="rank-col">Pos</th><th>Jugador</th><th class="points-col">Pts</th><th style="text-align:right">BH</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="tab-export" class="tab-content">
        <div class="card">
            <h3>Documentos del Torneo</h3>
            <button class="export" onclick="downloadPDF()">‚¨áÔ∏è Descargar Clasificaci√≥n</button>
            <button class="export" style="background-color: var(--primary); margin-top: 15px;" onclick="downloadMatchesPDF()">üìÖ Descargar Emparejamientos</button>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('tab-setup', this)"><span class="nav-icon">‚öôÔ∏è</span>Config</div>
    <div class="nav-item" onclick="switchTab('tab-rounds', this)"><span class="nav-icon">üìÖ</span>Rondas</div>
    <div class="nav-item" onclick="switchTab('tab-ranking', this)"><span class="nav-icon">üèÜ</span>Ranking</div>
    <div class="nav-item" onclick="switchTab('tab-export', this)"><span class="nav-icon">üìÑ</span>PDF</div>
</div>

<div id="pwdModal" class="modal">
    <div class="modal-content">
        <h3>Acceso Admin</h3>
        <input type="password" id="pwdInput" style="width:100%; padding:10px; margin:10px 0;">
        <button onclick="checkPassword()">Entrar</button>
        <button onclick="closePasswordModal()">Cancelar</button>
    </div>
</div>
<div id="confirmModal" class="modal"><div class="modal-content"><h3 id="confirmTitle"></h3><p id="confirmMessage"></p><button onclick="closeConfirmModal(false)">Cancelar</button><button onclick="closeConfirmModal(true)">Confirmar</button></div></div>
<div id="toast"></div>

<script>
    // --- L√ìGICA DE CONTROL DE VERSI√ìN (ANTI-BUCLE) ---
    const APP_VERSION = "1.0.9"; 
    (function() {
        const savedV = localStorage.getItem('siurot_v');
        if (savedV !== APP_VERSION) {
            localStorage.setItem('siurot_v', APP_VERSION); // GUARDAMOS PRIMERO
            if (savedV) { // Solo recargamos si no es la primera vez que entra en la vida
                window.location.replace(window.location.pathname + "?u=" + Date.now());
            }
        }
    })();

    const ADMIN_PASS = "bejherro";
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyeRMzVOAm3h6qE7bqoVy2P7_g1NmkGxhImqqW0Z3mAIkgF5Fr0V_AODKf2o4ciPOZO/exec";
    
    let isAdmin = false, appData = { players: [], matches: [], started: false }, currentRound = 1, pendingAction = null;

    document.addEventListener('DOMContentLoaded', () => { fetchFromGoogle(); });

    async function fetchFromGoogle() {
        showLoading("Sincronizando...");
        try {
            const res = await fetch(`${SCRIPT_URL}?action=read&t=${Date.now()}`);
            const data = await res.json();
            if (data.db) appData = data.db;
            renderUI();
        } catch (e) { showToast("Error de conexi√≥n"); }
        finally { hideLoading(); }
    }

    async function syncToGoogle() {
        if (!isAdmin) return;
        showLoading("Guardando...");
        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: 'sync', matches: appData.matches, players: appData.players })
            });
            setTimeout(fetchFromGoogle, 1000);
            showToast("‚úÖ Resultados guardados");
        } catch (e) { showToast("Error al guardar"); }
    }

    // --- L√ìGICA DE RANKING Y UI ---
    function calculateRanking() {
        let standings = appData.players.map(p => ({ ...p, points: 0, buchholz: 0 }));
        appData.matches.forEach(m => {
            if (m.result === '1-0') standings.find(s => s.id === m.player1Id).points += 1;
            else if (m.result === '0-1') standings.find(s => s.id === m.player2Id).points += 1;
            else if (m.result === '1/2-1/2') {
                standings.find(s => s.id === m.player1Id).points += 0.5;
                standings.find(s => s.id === m.player2Id).points += 0.5;
            }
        });
        standings.forEach(p => {
            let bh = 0;
            appData.matches.forEach(m => {
                let oppId = m.player1Id === p.id ? m.player2Id : (m.player2Id === p.id ? m.player1Id : -1);
                if (oppId !== -1) bh += (standings.find(s => s.id === oppId) || {points:0}).points;
            });
            p.buchholz = bh;
        });
        return standings.sort((a,b) => b.points - a.points || b.buchholz - a.buchholz);
    }

    function renderUI() {
        document.getElementById('playersInput').value = appData.players.map(p=>p.name).join('\n');
        document.getElementById('resetCard').style.display = appData.started ? "block" : "none";
        if (appData.started) { renderRoundSelector(); renderMatches(currentRound); renderRanking(); }
    }

    function renderRoundSelector() {
        const container = document.getElementById('roundSelector');
        container.innerHTML = "";
        const rounds = [...new Set(appData.matches.map(m=>m.round))];
        rounds.forEach(r => {
            const chip = document.createElement('div');
            chip.className = `round-chip ${r===currentRound ? 'active' : ''}`;
            chip.innerText = `Ronda ${r}`;
            chip.onclick = () => { currentRound = r; renderRoundSelector(); renderMatches(r); };
            container.appendChild(chip);
        });
    }

    function renderMatches(r) {
        const container = document.getElementById('matchesContainer');
        container.innerHTML = "";
        appData.matches.filter(m=>m.round===r).forEach((m, idx) => {
            const p1 = appData.players.find(p=>p.id===m.player1Id), p2 = appData.players.find(p=>p.id===m.player2Id);
            container.innerHTML += `<div class="match-card">
                <div class="match-header">Mesa ${idx+1}</div>
                <div class="players">
                    <div class="player-name">‚ôî ${p1.name}</div><div class="vs">vs</div><div class="player-name">${p2.name} ‚ôö</div>
                </div>
                <select class="result-select editable-element" onchange="updateMatch('${m.id}', this.value)">
                    <option value="" ${!m.result?'selected':''}>Pendiente...</option>
                    <option value="1-0" ${m.result==='1-0'?'selected':''}>Victoria Blancas</option>
                    <option value="0-1" ${m.result==='0-1'?'selected':''}>Victoria Negras</option>
                    <option value="1/2-1/2" ${m.result==='1/2-1/2'?'selected':''}>Tablas</option>
                </select>
            </div>`;
        });
    }

    function renderRanking() {
        const tbody = document.querySelector('#rankingTable tbody');
        tbody.innerHTML = "";
        calculateRanking().forEach((p, i) => {
            tbody.innerHTML += `<tr><td>${i+1}</td><td>${p.name}</td><td class="points-col">${p.points}</td><td style="text-align:right">${p.buchholz.toFixed(1)}</td></tr>`;
        });
    }

    function updateMatch(id, res) { 
        const m = appData.matches.find(x=>x.id===id); 
        if (m) m.result = res; 
        renderMatches(currentRound);
    }

    // --- FUNCIONES PDF ---
    function downloadPDF() {
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        doc.text("Clasificaci√≥n - Ajedrez Siurot", 15, 20);
        let y = 30;
        calculateRanking().forEach((p, i) => {
            doc.text(`${i+1}. ${p.name.padEnd(20)} Pts: ${p.points} BH: ${p.buchholz}`, 15, y);
            y += 10;
        });
        doc.save("Clasificacion.pdf");
    }

    function downloadMatchesPDF() {
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        doc.setFontSize(16); doc.text("Emparejamientos - Ajedrez Siurot", 15, 20);
        let y = 30;
        const rounds = [...new Set(appData.matches.map(m=>m.round))];
        rounds.forEach(r => {
            doc.setFont(undefined, 'bold'); doc.text(`RONDA ${r}`, 15, y); y += 10;
            doc.setFont(undefined, 'normal');
            appData.matches.filter(m=>m.round===r).forEach((m, i) => {
                const p1 = appData.players.find(p=>p.id===m.player1Id).name;
                const p2 = appData.players.find(p=>p.id===m.player2Id).name;
                doc.text(`Mesa ${i+1}: ${p1} vs ${p2}`, 20, y); y += 8;
                if(y > 270) { doc.addPage(); y = 20; }
            });
            y += 5;
        });
        doc.save("Emparejamientos.pdf");
    }

    // --- UTILIDADES ---
    function showLoading(t) { document.getElementById('loadingText').innerText = t; document.getElementById('loadingOverlay').style.display = "flex"; }
    function hideLoading() { document.getElementById('loadingOverlay').style.display = "none"; }
    function showToast(m) { const x = document.getElementById("toast"); x.innerText = m; x.className = "show"; setTimeout(()=>x.className="", 3000); }
    function openPasswordModal() { document.getElementById('pwdModal').style.display="flex"; }
    function closePasswordModal() { document.getElementById('pwdModal').style.display="none"; }
    function checkPassword() {
        if(document.getElementById('pwdInput').value===ADMIN_PASS) {
            isAdmin = true; closePasswordModal(); 
            document.body.classList.remove('is-locked');
            document.getElementById('adminBtn').innerHTML = "üîì";
            showToast("Acceso concedido");
        } else showToast("Error");
    }
    function switchTab(id, el) {
        document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
        el.classList.add('active');
    }
</script>
</body>
</html>
